{% extends "base.html" %}
{% block content %}
<style>
    /* Enhanced Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideIn {
        from { 
            transform: translateX(-30px); 
            opacity: 0; 
        }
        to { 
            transform: translateX(0); 
            opacity: 1; 
        }
    }

    @keyframes slideInRight {
        from { 
            transform: translateX(30px); 
            opacity: 0; 
        }
        to { 
            transform: translateX(0); 
            opacity: 1; 
        }
    }
    
    @keyframes slideOutRight {
        from { 
            transform: translateX(0); 
            opacity: 1; 
        }
        to { 
            transform: translateX(30px); 
            opacity: 0; 
        }
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0);
        }
        40% {
            transform: translateY(-10px);
        }
        60% {
            transform: translateY(-5px);
        }
    }

    @keyframes shimmer {
        0% {
            background-position: -200px 0;
        }
        100% {
            background-position: calc(200px + 100%) 0;
        }
    }

    @keyframes float {
        0% {
            transform: translateY(0px);
        }
        50% {
            transform: translateY(-10px);
        }
        100% {
            transform: translateY(0px);
        }
    }

    @keyframes glow {
        0% {
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }
        50% {
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.8), 0 0 30px rgba(0, 123, 255, 0.6);
        }
        100% {
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }
    }

    @keyframes rainbow {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    /* Enhanced Card Styles */
    .upload-card {
        animation: fadeInUp 0.8s ease-out forwards;
        border: none;
        border-radius: 25px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
    }

    .upload-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        border-radius: 25px;
        z-index: 1;
    }

    .upload-card:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow: 0 30px 60px rgba(102, 126, 234, 0.4);
        animation: glow 2s ease-in-out infinite;
    }

    .upload-card > * {
        position: relative;
        z-index: 2;
    }

    /* Title Styles */
    .page-title {
        color: #ffffff;
        font-weight: 700;
        margin-bottom: 2rem;
        position: relative;
        padding-bottom: 15px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        animation: float 3s ease-in-out infinite;
    }

    .page-title:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
        background-size: 300% 300%;
        border-radius: 2px;
        animation: rainbow 3s ease infinite;
    }

    .page-title i {
        animation: bounce 2s infinite;
        color: #ffd700;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    /* Form Controls */
    .form-control, .form-select {
        border-radius: 15px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        padding: 15px 20px;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        color: #2c3e50;
        font-weight: 500;
        font-size: 14px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .form-control:focus, .form-select:focus {
        border-color: #ff6b6b;
        box-shadow: 0 0 0 0.3rem rgba(255, 107, 107, 0.25), 0 8px 25px rgba(255, 107, 107, 0.3);
        transform: translateY(-3px) scale(1.02);
        background: rgba(255, 255, 255, 1);
    }

    .form-control::placeholder {
        color: #6c757d;
        font-style: italic;
    }

    .form-label {
        color: #ffffff;
        font-weight: 600;
        font-size: 14px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        margin-bottom: 8px;
    }

    .form-label i {
        color: #ffd700;
        margin-right: 8px;
        animation: pulse 2s infinite;
    }

    /* Input Method Selection */
    .input-method-container {
        display: flex;
        gap: 25px;
        justify-content: center;
        margin-bottom: 2.5rem;
    }

    .method-option {
        flex: 1;
        max-width: 220px;
        text-align: center;
        padding: 25px 20px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        animation: slideIn 0.6s ease-out forwards;
        border: 2px solid rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
    }

    .method-option::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .method-option:hover::before {
        left: 100%;
    }

    .method-option:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-8px) scale(1.05);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        border-color: rgba(255, 255, 255, 0.4);
    }

    .method-option input[type="radio"] {
        display: none;
    }

    .method-option input[type="radio"]:checked + label {
        color: #ffd700;
        font-weight: bold;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .method-option input[type="radio"]:checked {
        background: rgba(255, 215, 0, 0.2);
        border-color: #ffd700;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }

    .method-option i {
        font-size: 28px;
        margin-bottom: 12px;
        color: #ffffff;
        transition: all 0.3s ease;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .method-option:hover i {
        color: #ffd700;
        transform: scale(1.2) rotate(5deg);
        text-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
    }

    .method-option label {
        color: #ffffff;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    /* Preview Containers */
    .preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 25px;
        justify-content: center;
    }

    .preview-item {
        position: relative;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border: 3px solid rgba(255, 255, 255, 0.3);
        animation: fadeInUp 0.6s ease-out;
    }

    .preview-item:hover {
        transform: translateY(-8px) scale(1.05);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
        border-color: #ffd700;
    }

    .preview-item img {
        width: 180px;
        height: 135px;
        object-fit: cover;
        border-radius: 17px;
        transition: all 0.3s ease;
    }

    .preview-item:hover img {
        filter: brightness(1.1) saturate(1.2);
    }

    .delete-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #6c757d;
        font-size: 14px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .delete-btn:hover {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
        transform: scale(1.1) rotate(90deg);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        border-color: #ff6b6b;
    }

    /* Camera Section */
    .camera-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 25px;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .camera-preview {
        width: 100%;
        max-width: 500px;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin: 0 auto;
    }

    /* Action Buttons */
    .action-btn {
        padding: 15px 35px;
        border-radius: 50px;
        font-weight: 700;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        text-transform: uppercase;
        letter-spacing: 1.5px;
        border: none;
        position: relative;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .action-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
    }

    .action-btn:hover::before {
        left: 100%;
    }

    .btn-capture {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24, #ff9ff3);
        background-size: 200% 200%;
        animation: rainbow 3s ease infinite;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .btn-submit {
        background: linear-gradient(45deg, #4ecdc4, #44a08d, #093637);
        background-size: 200% 200%;
        animation: rainbow 3s ease infinite;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .action-btn:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        animation: bounce 0.6s ease;
    }

    .action-btn:active {
        transform: translateY(-2px) scale(1.02);
    }

    /* Helper Text */
    .helper-text {
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        margin-top: 0.8rem;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        animation: fadeInUp 0.6s ease-out 0.3s both;
    }

    .helper-text i {
        color: #ffd700;
        animation: pulse 2s infinite;
    }

    /* Toast Messages - Bottom Right Corner */
    .toast-message {
        position: fixed;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        min-width: 300px;
        animation: slideInRight 0.4s ease-out;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-radius: 12px;
        overflow: hidden;
    }
    
    .toast-message.error-message {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        border: 2px solid #dc3545;
        color: #721c24;
    }
    
    .toast-message.success-message {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        border: 2px solid #28a745;
        color: #155724;
    }
    
    .toast-message.warning-message {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border: 2px solid #ffc107;
        color: #856404;
    }
    
    .toast-message .alert {
        margin: 0;
        border: none;
        border-radius: 0;
        padding: 15px 20px;
        font-weight: 600;
        position: relative;
    }
    
    .toast-message .alert::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
        animation: shimmer 2s infinite;
    }
    
    .toast-message .alert > * {
        position: relative;
        z-index: 2;
    }
    
    .toast-message i {
        font-size: 1.2rem;
        margin-right: 10px;
    }
    
    .toast-message.success-message i {
        color: #28a745;
        animation: bounce 1s infinite;
    }
    
    .toast-message.error-message i {
        color: #dc3545;
        animation: pulse 1s infinite;
    }
    
    /* Close button for toast messages */
    .toast-close {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: inherit;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
        z-index: 3;
    }
    
    .toast-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }
    
    /* Progress Message Styling */
    .toast-message.progress-message {
        bottom: 80px; /* Above toast messages */
        z-index: 9998;
        background: linear-gradient(135deg, #d1ecf1, #bee5eb);
        border: 2px solid #17a2b8;
    }
    
    .toast-message.progress-message .alert {
        background: transparent;
        border: none;
        color: #0c5460;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .toast-message {
            bottom: 10px;
            right: 10px;
            left: 10px;
            max-width: none;
            min-width: auto;
        }
        
        .toast-message.progress-message {
            bottom: 70px;
        }
    }

    /* Modal Styles */
    .camera-modal {
        display: none;
        position: fixed;
        z-index: 1050;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease-out;
    }

    .camera-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 20px;
        padding: 0;
        max-width: 95vw;
        max-height: 95vh;
        width: 800px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        animation: slideInUp 0.4s ease-out;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    @media (max-width: 768px) {
        .modal-content {
            max-width: 98vw;
            max-height: 98vh;
            width: 100%;
            margin: 10px;
        }
        
        .warning-message {
            padding: 15px 12px;
            font-size: 14px;
            margin-bottom: 20px;
        }
    }

    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        background-size: 200% 200%;
        animation: rainbow 4s ease infinite;
        color: white;
        padding: 25px 35px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        overflow: hidden;
    }

    .modal-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
        animation: shimmer 2s infinite;
    }

    .modal-title {
        margin: 0;
        font-size: 1.6rem;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        animation: float 3s ease-in-out infinite;
        position: relative;
        z-index: 2;
    }

    .modal-title i {
        color: #ffd700;
        animation: bounce 2s infinite;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .close-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        z-index: 2;
        backdrop-filter: blur(10px);
    }

    .close-btn:hover {
        background: rgba(255, 107, 107, 0.8);
        border-color: #ff6b6b;
        transform: rotate(90deg) scale(1.1);
        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
    }

    .modal-body {
        padding: 30px;
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }

    @media (max-width: 768px) {
        .modal-body {
            padding: 20px 15px;
        }
    }

    .picture-counter {
        background: linear-gradient(135deg, #4ecdc4, #44a08d, #093637);
        background-size: 200% 200%;
        animation: rainbow 3s ease infinite;
        color: white;
        padding: 18px 25px;
        border-radius: 20px;
        margin-bottom: 25px;
        text-align: center;
        font-weight: 700;
        font-size: 1.2rem;
        box-shadow: 0 8px 25px rgba(78, 205, 196, 0.4);
        position: relative;
        overflow: hidden;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .picture-counter::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        animation: shimmer 2s infinite;
    }

    .picture-counter i {
        animation: bounce 2s infinite;
        color: #ffd700;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        margin-right: 8px;
    }

    .counter-warning {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24, #ff9ff3) !important;
        background-size: 200% 200% !important;
        animation: rainbow 2s ease infinite, pulse 1s infinite !important;
    }

    .counter-danger {
        background: linear-gradient(135deg, #ff4757, #c44569, #f8b500) !important;
        background-size: 200% 200% !important;
        animation: rainbow 1s ease infinite, pulse 0.5s infinite !important;
    }

    .warning-message {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border: 2px solid #ffd700;
        color: #856404;
        padding: 18px 20px;
        border-radius: 15px;
        margin-bottom: 25px;
        display: none;
        animation: fadeInUp 0.6s ease-out, pulse 2s infinite;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        position: relative;
        overflow: visible;
        width: 100%;
        word-wrap: break-word;
        white-space: normal;
        text-align: center;
    }

    .warning-message::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer 2s infinite;
    }

    .warning-message.show {
        display: block;
    }

    .warning-message.danger {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        border-color: #dc3545;
        color: #721c24;
        animation: fadeInUp 0.6s ease-out, pulse 1s infinite;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }

    .warning-message i {
        color: #ff6b6b;
        animation: bounce 1s infinite;
    }

    .modal-camera-preview {
        width: 100%;
        max-width: 600px;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        margin: 0 auto 25px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        position: relative;
        animation: float 4s ease-in-out infinite;
        flex-shrink: 0;
    }

    @media (max-width: 768px) {
        .modal-camera-preview {
            max-width: 100%;
            margin: 0 auto 15px;
            max-height: 40vh;
        }
        
        .modal-camera-preview video {
            width: 100%;
            height: auto;
            max-height: 40vh;
            object-fit: cover;
        }
    }

    .modal-camera-preview::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
        animation: shimmer 3s infinite;
        z-index: 1;
        pointer-events: none;
    }

    .modal-camera-preview video {
        width: 100%;
        height: auto;
        display: block;
        position: relative;
        z-index: 0;
    }

    .modal-controls {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }

    .modal-controls select {
        padding: 12px 18px;
        border-radius: 15px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        font-size: 14px;
        font-weight: 600;
        color: #2c3e50;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .modal-controls select:focus {
        border-color: #ff6b6b;
        box-shadow: 0 0 0 0.3rem rgba(255, 107, 107, 0.25);
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 1);
    }

    .modal-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
        flex-shrink: 0;
        padding-top: 15px;
    }

    @media (max-width: 768px) {
        .modal-actions {
            gap: 10px;
            margin-top: 15px;
            padding-top: 10px;
        }
        
        .btn-modal {
            padding: 10px 20px;
            font-size: 14px;
        }
    }

    .btn-modal {
        padding: 12px 25px;
        border-radius: 50px;
        font-weight: 600;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        border: none;
        cursor: pointer;
    }

    .btn-capture-modal {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24, #ff9ff3);
        background-size: 200% 200%;
        animation: rainbow 3s ease infinite;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .btn-close-modal {
        background: linear-gradient(45deg, #4ecdc4, #44a08d, #093637);
        background-size: 200% 200%;
        animation: rainbow 3s ease infinite;
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .btn-modal:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        animation: bounce 0.6s ease;
    }

    .btn-capture-modal:disabled {
        background: linear-gradient(45deg, #6c757d, #495057) !important;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
        animation: none !important;
        opacity: 0.6;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="upload-card p-4">
                <h2 class="text-center page-title">
                    <i class="fas fa-tasks me-2"></i>Upload Technical Activity
                </h2>

                <form enctype="multipart/form-data" method="post" id="uploadForm">
                    {% csrf_token %}

                    <div class="mb-4">
                        <label class="form-label fw-bold" for="id_name">
                            <i class="fas fa-clipboard me-2"></i>Activity Name
                        </label>
                        <input class="form-control" id="id_name" name="name" 
                               placeholder="Enter activity name" type="text" required>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold" for="id_location">
                            <i class="fas fa-map-marker-alt me-2"></i>Location
                        </label>
                        <input class="form-control" id="id_location" name="location" 
                               placeholder="Enter location" required type="text">
                    </div>

                    <div class="input-method-container">
                        <div class="method-option">
                            <input type="radio" name="input_method" id="uploadRadio" value="upload" checked>
                            <label for="uploadRadio">
                                <i class="fas fa-file-upload d-block mb-2"></i>
                                Upload Images
                            </label>
                        </div>
                        <div class="method-option">
                            <input type="radio" name="input_method" id="cameraRadio" value="camera">
                            <label for="cameraRadio">
                                <i class="fas fa-camera d-block mb-2"></i>
                                Use Camera
                            </label>
                        </div>
                    </div>

                    <!-- Upload Section -->
                    <div class="mb-4" id="upload-section">
                        <label class="form-label fw-bold" for="image-input">
                            <i class="fas fa-images me-2"></i>Upload Images
                        </label>
                        <input type="file" class="form-control" name="image" id="image-input" 
                               multiple accept="image/*">
                        <div class="helper-text">
                            <i class="fas fa-info-circle"></i>
                            Maximum 20 images, each up to 15MB. Standard image formats recommended.
                        </div>
                    </div>

                    <!-- Camera Section -->
                    <div class="camera-section d-none" id="camera-section">
                        <div class="text-center">
                            <button type="button" class="action-btn btn-capture" id="openCameraModal">
                                <i class="fas fa-camera me-2"></i>Open Camera
                            </button>
                        </div>
                        
                        <input type="hidden" name="captured_images" id="captured-images">
                        <div class="preview-container" id="captured-images-preview"></div>
                        
                        <div class="helper-text">
                            <i class="fas fa-info-circle"></i>
                            Maximum 20 photos allowed. Standard photo formats recommended.
                        </div>
                    </div>

                    <!-- Image Previews -->
                    <div class="preview-container" id="preview-container"></div>

                    <div class="text-center mt-4">
                        <button class="action-btn btn-submit" type="submit">
                            <i class="fas fa-upload me-2"></i>Upload Activity
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Camera Modal -->
<div class="camera-modal" id="cameraModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-camera me-2"></i>Camera Capture
            </h3>
            <button class="close-btn" id="closeModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Picture Counter -->
            <div class="picture-counter" id="pictureCounter">
                <i class="fas fa-images me-2"></i>
                <span id="counterText">0 / 20 photos taken</span>
            </div>


            <!-- Camera Controls -->
            <div class="modal-controls">
                <select id="modalCameraSelect">
                    <option value="">Loading cameras...</option>
                </select>
            </div>

            <!-- Camera Preview -->
            <div class="modal-camera-preview">
                <video id="modalCameraPreview" autoplay playsinline></video>
            </div>

            <!-- Error Display -->
            <div id="modalCameraError" class="error-message alert alert-danger d-none"></div>

            <!-- Modal Actions -->
            <div class="modal-actions">
                <button type="button" class="btn-modal btn-capture-modal" id="modalCaptureBtn">
                    <i class="fas fa-camera me-2"></i>Capture Photo
                </button>
                <button type="button" class="btn-modal btn-close-modal" id="modalCloseBtn">
                    <i class="fas fa-check me-2"></i>Done
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // DOM Elements
    const uploadRadio = document.getElementById('uploadRadio');
    const cameraRadio = document.getElementById('cameraRadio');
    const uploadSection = document.getElementById('upload-section');
    const cameraSection = document.getElementById('camera-section');
    const capturedImagesInput = document.getElementById('captured-images');
    const capturedImagesPreview = document.getElementById('captured-images-preview');
    
    // Function to close toast message (global function)
    window.closeToast = function(closeBtn) {
        const toast = closeBtn.closest('.toast-message');
        if (toast) {
            toast.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
    }
    
    // Function to clear all toast messages
    function clearToastMessages() {
        const existingToasts = document.querySelectorAll('.toast-message');
        existingToasts.forEach(toast => {
            const closeBtn = toast.querySelector('.toast-close');
            if (closeBtn) {
                closeToast(closeBtn);
            }
        });
    }
    
    // Modal Elements
    const cameraModal = document.getElementById('cameraModal');
    const openCameraModal = document.getElementById('openCameraModal');
    const closeModal = document.getElementById('closeModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalCameraSelect = document.getElementById('modalCameraSelect');
    const modalCameraPreview = document.getElementById('modalCameraPreview');
    const modalCameraError = document.getElementById('modalCameraError');
    const modalCaptureBtn = document.getElementById('modalCaptureBtn');
    const pictureCounter = document.getElementById('pictureCounter');
    const counterText = document.getElementById('counterText');

    // Global Variables
    let stream;
    let capturedImages = [];
    const MAX_IMAGES = 20;
    const MAX_IMAGE_SIZE = 15 * 1024 * 1024; // 15MB

    // Fixed medium quality settings for optimal file size management
    const CAMERA_QUALITY = {
        width: 1280, 
        height: 960, 
        jpegQuality: 0.8  // Medium quality JPEG compression
    };

    // Camera shutter sound function
    function playCameraSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Create a short "click" sound
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        } catch (error) {
            // Fallback: silent if audio context fails
            console.log('Audio not available');
        }
    }

    // Event Listeners
    uploadRadio.addEventListener('change', toggleInputMethod);
    cameraRadio.addEventListener('change', toggleInputMethod);
    openCameraModal.addEventListener('click', openModal);
    closeModal.addEventListener('click', closeModalHandler);
    modalCloseBtn.addEventListener('click', closeModalHandler);
    modalCameraSelect.addEventListener('change', startModalCamera);
    modalCaptureBtn.addEventListener('click', capturePhoto);

    // Modal Functions
    function openModal() {
        cameraModal.classList.add('show');
        loadModalCameras();
        startModalCamera();
        updateCounter();
    }

    function closeModalHandler() {
        cameraModal.classList.remove('show');
        stopCamera();
    }

    // Close modal when clicking outside
    cameraModal.addEventListener('click', (e) => {
        if (e.target === cameraModal) {
            closeModalHandler();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && cameraModal.classList.contains('show')) {
            closeModalHandler();
        }
    });

    // Camera Functions
    async function loadModalCameras() {
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            
            modalCameraSelect.innerHTML = videoDevices.length 
                ? videoDevices.map(device => 
                    `<option value="${device.deviceId}">${device.label || `Camera ${videoDevices.indexOf(device) + 1}`}</option>`
                ).join('')
                : '<option value="">No cameras found</option>';
        } catch (error) {
            showModalError('Failed to load cameras: ' + error.message);
        }
    }

    function showModalError(message) {
        modalCameraError.textContent = message;
        modalCameraError.classList.remove('d-none');
    }

    function hideModalError() {
        modalCameraError.classList.add('d-none');
    }

    async function startModalCamera() {
        stopCamera();
        hideModalError();
        
        try {
            const constraints = {
                video: {
                    deviceId: modalCameraSelect.value ? { exact: modalCameraSelect.value } : undefined,
                    width: { ideal: CAMERA_QUALITY.width },
                    height: { ideal: CAMERA_QUALITY.height },
                    facingMode: { ideal: "environment" }
                }
            };

            stream = await navigator.mediaDevices.getUserMedia(constraints);
            modalCameraPreview.srcObject = stream;
        } catch (error) {
            showModalError('Camera access error: ' + error.message);
        }
    }

    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }

    // Counter and Warning Functions
    function updateCounter() {
        const count = capturedImages.length;
        counterText.textContent = `${count} / ${MAX_IMAGES} photos taken`;
        
        // Update counter styling based on count
        pictureCounter.classList.remove('counter-warning', 'counter-danger');
        
        if (count >= MAX_IMAGES) {
            pictureCounter.classList.add('counter-danger');
            modalCaptureBtn.disabled = true;
        } else if (count >= 16) {
            pictureCounter.classList.add('counter-warning');
            modalCaptureBtn.disabled = false;
        } else if (count >= 10) {
            pictureCounter.classList.add('counter-warning');
            modalCaptureBtn.disabled = false;
        } else {
            modalCaptureBtn.disabled = false;
        }
    }

    // Photo Capture Function
    function capturePhoto() {
        if (capturedImages.length >= MAX_IMAGES) {
            showModalError(`Maximum ${MAX_IMAGES} images allowed`);
            return;
        }

        // Play camera shutter sound
        playCameraSound();

        const canvas = document.createElement('canvas');
        
        // Force 4:3 aspect ratio
        const targetWidth = modalCameraPreview.videoWidth;
        const targetHeight = Math.round(targetWidth * (3/4));
        
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        const context = canvas.getContext('2d');
        
        // Center the image and crop to 4:3
        const sourceX = 0;
        const sourceY = (modalCameraPreview.videoHeight - targetHeight) / 2;
        context.drawImage(modalCameraPreview, sourceX, sourceY, targetWidth, targetHeight, 0, 0, targetWidth, targetHeight);

        // Use fixed medium quality for JPEG compression
        let base64Image = canvas.toDataURL('image/jpeg', CAMERA_QUALITY.jpegQuality);
        
        const container = document.createElement('div');
        container.className = 'preview-item';
        
        const img = document.createElement('img');
        img.src = base64Image;
        
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
        deleteBtn.className = 'delete-btn';
        deleteBtn.onclick = (e) => {
            e.preventDefault();
            container.style.opacity = '0';
            container.style.transform = 'scale(0.8)';
            setTimeout(() => {
                const index = capturedImages.indexOf(base64Image);
                if (index > -1) {
                    capturedImages.splice(index, 1);
                    container.remove();
                    capturedImagesInput.value = JSON.stringify(capturedImages);
                    updateCounter();
                }
            }, 300);
        };
        
        container.appendChild(img);
        container.appendChild(deleteBtn);
        capturedImagesPreview.appendChild(container);

        // Animation
        container.style.opacity = '0';
        container.style.transform = 'scale(0.8)';
        setTimeout(() => {
            container.style.opacity = '1';
            container.style.transform = 'scale(1)';
        }, 50);

        capturedImages.push(base64Image);
        capturedImagesInput.value = JSON.stringify(capturedImages);
        updateCounter();
        hideModalError();
    }

    // Input Method Toggle
    function toggleInputMethod() {
        if (uploadRadio.checked) {
            uploadSection.classList.remove('d-none');
            cameraSection.classList.add('d-none');
            stopCamera();
        } else {
            uploadSection.classList.add('d-none');
            cameraSection.classList.remove('d-none');
        }
    }

    // File Upload Handler
    document.getElementById('image-input').addEventListener('change', function(event) {
        const files = Array.from(event.target.files);
        
        if (files.length > MAX_IMAGES) {
            alert(`Maximum ${MAX_IMAGES} images allowed`);
            this.value = '';
            return;
        }

        const oversizedFiles = files.filter(file => file.size > MAX_IMAGE_SIZE);
        if (oversizedFiles.length > 0) {
            alert(`Some files exceed the ${MAX_IMAGE_SIZE / 1024 / 1024}MB limit:\n${oversizedFiles.map(f => f.name).join('\n')}`);
            this.value = '';
            return;
        }

        const previewContainer = document.getElementById('preview-container');
        previewContainer.innerHTML = '';

        files.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Check aspect ratio - More flexible validation
                    const aspectRatio = img.width / img.height;
                    
                    // Only warn for extremely wide or tall images
                    if (aspectRatio < 0.5 || aspectRatio > 3.0) {
                        alert(`Image "${file.name}" has extreme aspect ratio (current ratio: ${aspectRatio.toFixed(2)}). Please use a more standard image format.`);
                        return;
                    }

                    const container = document.createElement('div');
                    container.className = 'preview-item';
                    container.style.opacity = '0';
                    container.style.transform = 'scale(0.8)';
                    
                    const previewImg = document.createElement('img');
                    previewImg.src = e.target.result;
                    
                    container.appendChild(previewImg);
                    previewContainer.appendChild(container);

                    // Staggered animation
                    setTimeout(() => {
                        container.style.opacity = '1';
                        container.style.transform = 'scale(1)';
                    }, 50 * index);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    });

    // Form submission with error handling
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = document.querySelector('.btn-submit');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
        submitBtn.disabled = true;
        
        // Add progress indicator
        const progressContainer = document.getElementById('progressContainer') || createProgressContainer();
        progressContainer.style.display = 'block';
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            showUploadError('CSRF token not found. Please refresh the page.');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            return;
        }
        
        // Get form action URL
        const formAction = this.action || window.location.href;
        console.log('Submitting to:', formAction);
        
        fetch(formAction, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken.value,
                'Accept': 'application/json'
            }
        })
        .then(response => {
            updateProgress(50, 'Processing upload...');
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers.get('content-type'));
            console.log('Response URL:', response.url);
            
            if (response.ok) {
                updateProgress(75, 'Finalizing...');
                
                // Check if response is JSON (AJAX success)
                const contentType = response.headers.get('content-type');
                console.log('Content type:', contentType);
                
                if (contentType && contentType.includes('application/json')) {
                    console.log('Processing JSON response');
                    return response.json();
                } else {
                    console.log('Processing HTML response');
                    // Handle HTML response (traditional form submission)
                    return response.text();
                }
            } else {
                console.log('Response not OK:', response.status);
                // Handle error responses
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Upload failed');
                    });
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
            }
        })
        .then(data => {
            updateProgress(100, 'Complete!');
            console.log('Response data:', data);
            console.log('Data type:', typeof data);
            console.log('Data success:', data?.success);
            
            // Handle JSON response (AJAX success)
            if (typeof data === 'object' && data.success) {
                console.log('JSON success response detected');
                showSuccessMessage(data.message, data.uploaded_count);
                
                // Show warnings if any
                if (data.warnings && data.warnings.length > 0) {
                    console.log('Warnings detected:', data.warnings);
                    setTimeout(() => {
                        data.warnings.forEach(warning => {
                            showToastMessage(warning, 'warning');
                        });
                    }, 1000); // Show warnings after success message
                }
                
                // Clear form data and images
                clearFormAfterSuccess();
                
                // Immediate redirect
                console.log('Attempting immediate redirect...');
                setTimeout(() => {
                    console.log('Force redirecting...');
                    window.location.href = '/danao/activities/';
                }, 500);
                
                // Backup: if still on upload page after 3 seconds, force reload
                setTimeout(() => {
                    if (window.location.pathname.includes('upload')) {
                        console.log('Force reloading page...');
                        window.location.reload();
                    }
                }, 3000);
                return;
            }
            
            // Handle HTML response (fallback)
            if (typeof data === 'string') {
                const parser = new DOMParser();
                const doc = parser.parseFromString(data, 'text/html');
                const errorMessages = doc.querySelectorAll('.alert-danger, .error-message');
                
                if (errorMessages.length > 0) {
                    // Show errors without refreshing page
                    showUploadErrors(errorMessages);
                } else {
                    // Success - show message and redirect
                    console.log('HTML success response detected');
                    showSuccessMessage();
                    
                    // Clear form data and images
                    clearFormAfterSuccess();
                    
                    // Immediate redirect
                    console.log('Attempting immediate redirect...');
                    setTimeout(() => {
                        console.log('Force redirecting...');
                        window.location.href = '/danao/activities/';
                    }, 500);
                    
                    // Backup: if still on upload page after 3 seconds, force reload
                    setTimeout(() => {
                        if (window.location.pathname.includes('upload')) {
                            console.log('Force reloading page...');
                            window.location.reload();
                        }
                    }, 3000);
                }
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            
            // Handle different types of errors
            let errorMessage = 'Upload failed. Please try again.';
            
            if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                errorMessage = 'Network error: Unable to connect to server. Please check your internet connection and try again.';
            } else if (error.message.includes('CSRF')) {
                errorMessage = 'Security error: Please refresh the page and try again.';
            } else if (error.message.includes('413')) {
                errorMessage = 'File too large: Please reduce file sizes and try again.';
            } else if (error.message.includes('timeout')) {
                errorMessage = 'Upload timeout: Please try again with smaller files.';
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            showUploadError(errorMessage);
        })
        .finally(() => {
            // Clear timeout
            if (uploadTimeout) {
                clearTimeout(uploadTimeout);
            }
            
            // Hide progress container
            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);
            }
            
            // Restore button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
    
    // Function to show upload errors
    function showUploadErrors(errorElements) {
        // Clear any existing toast messages
        clearToastMessages();
        
        errorElements.forEach(error => {
            showToastMessage(error.innerHTML, 'error');
        });
    }
    
    // Function to show single upload error
    function showUploadError(message) {
        showToastMessage(message, 'error');
    }
    
    // Function to show success message
    function showSuccessMessage(message = null, uploadedCount = null) {
        const successMessage = message || 'Upload Successful!';
        const countText = uploadedCount ? ` (${uploadedCount} images uploaded)` : '';
        const fullMessage = `
            <strong>${successMessage}${countText}</strong> Your technical activity has been uploaded successfully. 
            <br><small>Redirecting to activities list...</small>
            <br><button class="btn btn-sm btn-outline-light mt-2" onclick="goToActivitiesList()">
                <i class="fas fa-arrow-right me-1"></i>Go to Activities List
            </button>
        `;
        
        showToastMessage(fullMessage, 'success');
    }
    
    // Function to show toast message
    function showToastMessage(message, type = 'success') {
        // Only clear existing messages if showing success or error (not warnings)
        if (type !== 'warning') {
            clearToastMessages();
        }
        
        const toast = document.createElement('div');
        toast.className = `toast-message ${type}-message`;
        
        let icon, alertClass;
        if (type === 'success') {
            icon = 'fa-check-circle';
            alertClass = 'success';
        } else if (type === 'warning') {
            icon = 'fa-exclamation-triangle';
            alertClass = 'warning';
        } else {
            icon = 'fa-exclamation-triangle';
            alertClass = 'danger';
        }
        
        toast.innerHTML = `
            <div class="alert alert-${alertClass}">
                <i class="fas ${icon}"></i>
                ${message}
                <button class="toast-close" onclick="closeToast(this)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Position the toast to stack properly
        const existingToasts = document.querySelectorAll('.toast-message');
        const toastIndex = existingToasts.length - 1;
        const bottomOffset = 20 + (toastIndex * 80); // 80px spacing between toasts
        toast.style.bottom = `${bottomOffset}px`;
        
        // Auto-close after 5 seconds for success, 8 seconds for errors, 6 seconds for warnings
        const autoCloseDelay = type === 'success' ? 5000 : type === 'warning' ? 6000 : 8000;
        setTimeout(() => {
            if (toast.parentNode) {
                closeToast(toast.querySelector('.toast-close'));
            }
        }, autoCloseDelay);
    }
    
    // Global redirect function
    window.goToActivitiesList = function() {
        console.log('Global redirect function called');
        window.location.href = '/danao/activities/';
    };
    
    // Function to redirect to activities list
    function redirectToActivitiesList() {
        console.log('Redirecting to activities list...');
        
        // Clear any existing timeouts
        if (window.redirectTimeout) {
            clearTimeout(window.redirectTimeout);
        }
        
        // Force redirect - try multiple methods
        setTimeout(() => {
            console.log('Executing redirect...');
            window.location.href = '/danao/activities/';
        }, 100);
        
        // Backup redirect
        setTimeout(() => {
            if (window.location.pathname.includes('upload')) {
                console.log('Backup redirect executing...');
                window.location.replace('/danao/activities/');
            }
        }, 500);
    }
    
    // Function to clear form after successful upload
    function clearFormAfterSuccess() {
        // Clear form fields
        const form = document.getElementById('uploadForm');
        if (form) {
            form.reset();
        }
        
        // Clear uploaded images
        const imageInput = document.getElementById('image-input');
        if (imageInput) {
            imageInput.value = '';
        }
        
        // Clear uploaded image previews
        const previewContainer = document.getElementById('preview-container');
        if (previewContainer) {
            previewContainer.innerHTML = '';
        }
        
        // Clear captured images
        const capturedImagesInput = document.getElementById('captured-images');
        if (capturedImagesInput) {
            capturedImagesInput.value = '';
        }
        
        // Clear captured image previews
        const capturedImagesPreview = document.getElementById('captured-images-preview');
        if (capturedImagesPreview) {
            capturedImagesPreview.innerHTML = '';
        }
        
        // Clear captured images array
        capturedImages = [];
        
        // Clear session storage
        sessionStorage.removeItem('danaoUploadForm');
        
        // Reset counter
        updateCounter();
        
        console.log('Form cleared after successful upload');
    }
    
    // Function to create progress container
    function createProgressContainer() {
        const container = document.createElement('div');
        container.id = 'progressContainer';
        container.className = 'toast-message progress-message';
        container.style.display = 'none';
        container.style.position = 'fixed';
        container.style.bottom = '80px'; // Above the toast messages
        container.style.right = '20px';
        container.style.zIndex = '9998';
        container.innerHTML = `
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <i class="fas fa-upload me-2"></i>
                    <div class="flex-grow-1">
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="uploadProgress">
                                <span id="progressText">Preparing upload...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(container);
        
        return container;
    }
    
    // Function to update progress
    function updateProgress(percent, text) {
        const progressBar = document.getElementById('uploadProgress');
        const progressText = document.getElementById('progressText');
        
        if (progressBar) {
            progressBar.style.width = percent + '%';
        }
        if (progressText) {
            progressText.textContent = text;
        }
    }
    
    // Function to retain form data on errors
    function retainFormData() {
        // Store form data in sessionStorage
        const formData = new FormData(document.getElementById('uploadForm'));
        const formObject = {};
        
        for (let [key, value] of formData.entries()) {
            if (key !== 'image' && key !== 'csrfmiddlewaretoken') {
                formObject[key] = value;
            }
        }
        
        // Store uploaded images
        const imageInput = document.getElementById('image-input');
        if (imageInput.files.length > 0) {
            const imageFiles = Array.from(imageInput.files);
            const imageData = [];
            
            imageFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageData.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        data: e.target.result
                    });
                    
                    if (index === imageFiles.length - 1) {
                        formObject.uploadedImages = imageData;
                        sessionStorage.setItem('danaoUploadForm', JSON.stringify(formObject));
                    }
                };
                reader.readAsDataURL(file);
            });
        } else {
            sessionStorage.setItem('danaoUploadForm', JSON.stringify(formObject));
        }
        
        // Store captured images
        const capturedImages = document.getElementById('captured-images').value;
        if (capturedImages) {
            formObject.capturedImages = capturedImages;
            sessionStorage.setItem('danaoUploadForm', JSON.stringify(formObject));
        }
    }
    
    // Function to restore form data
    function restoreFormData() {
        const savedData = sessionStorage.getItem('danaoUploadForm');
        if (savedData) {
            const formObject = JSON.parse(savedData);
            
            // Restore form fields
            Object.keys(formObject).forEach(key => {
                if (key !== 'uploadedImages' && key !== 'capturedImages') {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        element.value = formObject[key];
                    }
                }
            });
            
            // Restore uploaded images
            if (formObject.uploadedImages && formObject.uploadedImages.length > 0) {
                restoreUploadedImages(formObject.uploadedImages);
            }
            
            // Restore captured images
            if (formObject.capturedImages) {
                restoreCapturedImages(formObject.capturedImages);
            }
            
            // Clear saved data after restoration
            sessionStorage.removeItem('danaoUploadForm');
        }
    }
    
    // Function to restore uploaded images
    function restoreUploadedImages(imageData) {
        const previewContainer = document.getElementById('preview-container');
        previewContainer.innerHTML = '';
        
        imageData.forEach((imageInfo, index) => {
            const container = document.createElement('div');
            container.className = 'preview-item';
            container.style.opacity = '0';
            container.style.transform = 'scale(0.8)';
            
            const img = document.createElement('img');
            img.src = imageInfo.data;
            
            container.appendChild(img);
            previewContainer.appendChild(container);
            
            // Staggered animation
            setTimeout(() => {
                container.style.opacity = '1';
                container.style.transform = 'scale(1)';
            }, 50 * index);
        });
    }
    
    // Function to restore captured images
    function restoreCapturedImages(capturedImagesData) {
        try {
            const images = JSON.parse(capturedImagesData);
            const previewContainer = document.getElementById('captured-images-preview');
            previewContainer.innerHTML = '';
            
            images.forEach((base64Image, index) => {
                const container = document.createElement('div');
                container.className = 'preview-item';
                
                const img = document.createElement('img');
                img.src = base64Image;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteBtn.className = 'delete-btn';
                deleteBtn.onclick = (e) => {
                    e.preventDefault();
                    container.style.opacity = '0';
                    container.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        const index = capturedImages.indexOf(base64Image);
                        if (index > -1) {
                            capturedImages.splice(index, 1);
                            container.remove();
                            document.getElementById('captured-images').value = JSON.stringify(capturedImages);
                            updateCounter();
                        }
                    }, 300);
                };
                
                container.appendChild(img);
                container.appendChild(deleteBtn);
                previewContainer.appendChild(container);
                
                // Animation
                container.style.opacity = '0';
                container.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    container.style.opacity = '1';
                    container.style.transform = 'scale(1)';
                }, 50 * index);
            });
            
            // Update captured images array and counter
            capturedImages = images;
            document.getElementById('captured-images').value = capturedImagesData;
            updateCounter();
        } catch (error) {
            console.error('Error restoring captured images:', error);
        }
    }
    
    // Restore form data on page load
    document.addEventListener('DOMContentLoaded', function() {
        restoreFormData();
    });
    
    // Store form data before submission
    document.getElementById('uploadForm').addEventListener('submit', function() {
        retainFormData();
    });
    
    // Add fallback for traditional form submission if AJAX fails
    function fallbackToTraditionalSubmit() {
        console.log('Falling back to traditional form submission');
        const form = document.getElementById('uploadForm');
        
        // Remove the AJAX event listener temporarily
        form.removeEventListener('submit', arguments.callee);
        
        // Submit traditionally
        form.submit();
    }
    
    // Add timeout fallback
    let uploadTimeout;
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        // Set a timeout for the upload
        uploadTimeout = setTimeout(() => {
            console.log('Upload timeout - falling back to traditional submission');
            showUploadError('Upload is taking too long. Switching to traditional upload...');
            setTimeout(fallbackToTraditionalSubmit, 2000);
        }, 30000); // 30 second timeout
    });

    // Clear session storage on page unload
    window.addEventListener('beforeunload', function() {
        sessionStorage.removeItem('danaoUploadForm');
    });
    
    // Clear session storage on page hide (mobile)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            sessionStorage.removeItem('danaoUploadForm');
        }
    });

    // Stop camera on unload
    window.addEventListener("beforeunload", stopCamera);
</script>

{% endblock %}