{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-robot me-2"></i>
                            {{ chatbot_config.name }}
                        </h4>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-light btn-sm" id="newChatBtn">
                                <i class="fas fa-plus"></i> New Chat
                            </button>
                            <button class="btn btn-outline-light btn-sm" id="toggleChatBtn">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Chat Container -->
                    <div id="chatContainer" style="height: 500px; overflow-y: auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="p-3">
                            <!-- Messages will be displayed here -->
                            <div id="messagesContainer" class="d-flex flex-column gap-3">
                                <!-- Welcome message -->
                                <div class="message-bubble bot-message">
                                    <div class="message-content">
                                        <i class="fas fa-robot me-2 text-primary"></i>
                                        {{ chatbot_config.welcome_message }}
                                    </div>
                                    <div class="message-time text-muted small">
                                        <i class="fas fa-clock me-1"></i>
                                        <span id="welcomeTime"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input Area -->
                    <div class="border-top p-3 bg-light">
                        <!-- Suggested Questions Toggle -->
                        <div class="mb-2">
                            <button class="btn btn-sm btn-outline-primary" id="toggleQuestionsBtn">
                                <i class="fas fa-question-circle me-1"></i>
                                Quick Questions
                                <i class="fas fa-chevron-down ms-1" id="questionsChevron"></i>
                            </button>
                        </div>
                        
                        <!-- Suggested Questions Panel (Collapsible) -->
                        <div id="suggestedQuestionsPanel" class="mb-3" style="display: none;">
                            <div class="card shadow-sm">
                                <div class="card-body p-2">
                                    <div class="d-flex flex-wrap gap-1">
                                        <button class="btn btn-sm btn-outline-primary question-btn" data-question="What can I see on the dashboard?">
                                            <i class="fas fa-home me-1"></i>Dashboard
                                        </button>
                                        <button class="btn btn-sm btn-outline-success question-btn" data-question="How do I add a new facility?">
                                            <i class="fas fa-plus me-1"></i>Add Facility
                                        </button>
                                        <button class="btn btn-sm btn-outline-info question-btn" data-question="How do I log a technical activity?">
                                            <i class="fas fa-tasks me-1"></i>Log Activity
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning question-btn" data-question="How do I upload images?">
                                            <i class="fas fa-image me-1"></i>Upload Images
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary question-btn" data-question="How do I generate a report?">
                                            <i class="fas fa-file-pdf me-1"></i>Generate Report
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger question-btn" data-question="What are QR codes?">
                                            <i class="fas fa-qrcode me-1"></i>QR Codes
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary question-btn" data-question="Show me statistics">
                                            <i class="fas fa-chart-bar me-1"></i>Statistics
                                        </button>
                                        <button class="btn btn-sm btn-outline-success question-btn" data-question="How do I search for a facility?">
                                            <i class="fas fa-search me-1"></i>Search
                                        </button>
                                        <button class="btn btn-sm btn-outline-info question-btn" data-question="How do I navigate the menu?">
                                            <i class="fas fa-compass me-1"></i>Navigation
                                        </button>
                                        <button class="btn btn-sm btn-outline-dark question-btn" data-question="Help">
                                            <i class="fas fa-life-ring me-1"></i>Help & FAQ
                                        </button>
                                    </div>
                                    <div class="mt-2 text-center">
                                        <small class="text-muted">Click any question to ask</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   id="messageInput" 
                                   placeholder="Type your message or click a quick question above..."
                                   autocomplete="off">
                            <button class="btn btn-primary" type="button" id="sendBtn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb me-1"></i>
                                Try asking: "How do I add a facility?" or click Quick Questions above
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="d-none">
    <div class="d-flex justify-content-center align-items-center" style="height: 60px;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span class="ms-2 text-muted">AI is thinking...</span>
    </div>
</div>

<style>
/* Custom Chat Styles */
.message-bubble {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 18px;
    margin-bottom: 8px;
    position: relative;
    animation: fadeInUp 0.3s ease-out;
}

.user-message {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    margin-left: auto;
    text-align: right;
}

.bot-message {
    background: rgba(255, 255, 255, 0.95);
    color: #333;
    margin-right: auto;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.message-content {
    font-size: 14px;
    line-height: 1.4;
    word-wrap: break-word;
}

.message-time {
    font-size: 11px;
    margin-top: 4px;
    opacity: 0.7;
}

#chatContainer {
    scrollbar-width: thin;
    scrollbar-color: rgba(0, 123, 255, 0.3) transparent;
}

#chatContainer::-webkit-scrollbar {
    width: 6px;
}

#chatContainer::-webkit-scrollbar-track {
    background: transparent;
}

#chatContainer::-webkit-scrollbar-thumb {
    background: rgba(0, 123, 255, 0.3);
    border-radius: 3px;
}

#chatContainer::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 123, 255, 0.5);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.typing-indicator {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 18px;
    max-width: 80px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #007bff;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Question Button Styles */
.question-btn {
    font-size: 12px;
    padding: 6px 12px;
    border-radius: 20px;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.question-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.question-btn:active {
    transform: translateY(0);
}

#suggestedQuestionsPanel {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#toggleQuestionsBtn {
    transition: all 0.2s ease;
}

#toggleQuestionsBtn:hover {
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
}
</style>

<script>
class ChatbotWidget {
    constructor() {
        this.currentSessionId = null;
        this.isLoading = false;
        this.init();
    }

    init() {
        this.bindEvents();
        this.updateWelcomeTime();
        this.loadUserSessions();
    }

    bindEvents() {
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');
        const newChatBtn = document.getElementById('newChatBtn');
        const toggleQuestionsBtn = document.getElementById('toggleQuestionsBtn');

        sendBtn.addEventListener('click', () => this.sendMessage());
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        newChatBtn.addEventListener('click', () => this.startNewSession());
        
        toggleQuestionsBtn.addEventListener('click', () => this.toggleQuestions());

        // Handle suggested question button clicks
        document.addEventListener('click', (e) => {
            if (e.target.closest('.question-btn')) {
                const btn = e.target.closest('.question-btn');
                const question = btn.getAttribute('data-question');
                this.askQuestion(question);
            }
        });

        // Auto-resize input
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = messageInput.scrollHeight + 'px';
        });
    }
    
    toggleQuestions() {
        const panel = document.getElementById('suggestedQuestionsPanel');
        const chevron = document.getElementById('questionsChevron');
        
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            chevron.classList.remove('fa-chevron-down');
            chevron.classList.add('fa-chevron-up');
        } else {
            panel.style.display = 'none';
            chevron.classList.remove('fa-chevron-up');
            chevron.classList.add('fa-chevron-down');
        }
    }
    
    askQuestion(question) {
        const messageInput = document.getElementById('messageInput');
        messageInput.value = question;
        this.sendMessage();
    }

    async sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();

        if (!message || this.isLoading) return;

        // Add user message to chat
        this.addMessage(message, 'user');
        messageInput.value = '';
        messageInput.style.height = 'auto';

        // Show typing indicator
        this.showTypingIndicator();

        try {
            this.isLoading = true;
            this.updateSendButton(false);

            const response = await fetch('/chatbot/send-message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    message: message,
                    session_id: this.currentSessionId
                })
            });

            const data = await response.json();

            if (data.success) {
                // Update session ID if it's a new session
                if (!this.currentSessionId) {
                    this.currentSessionId = data.session_id;
                }

                // Remove typing indicator and add bot response
                this.hideTypingIndicator();
                this.addMessage(data.bot_response, 'bot');
            } else {
                this.hideTypingIndicator();
                this.addMessage('Sorry, I encountered an error. Please try again.', 'bot');
            }
        } catch (error) {
            console.error('Error sending message:', error);
            this.hideTypingIndicator();
            this.addMessage('Sorry, I\'m having trouble connecting. Please try again.', 'bot');
        } finally {
            this.isLoading = false;
            this.updateSendButton(true);
        }
    }

    addMessage(content, type) {
        const messagesContainer = document.getElementById('messagesContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-bubble ${type}-message`;

        const now = new Date();
        const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        messageDiv.innerHTML = `
            <div class="message-content">
                ${type === 'bot' ? '<i class="fas fa-robot me-2 text-primary"></i>' : ''}
                ${this.escapeHtml(content)}
            </div>
            <div class="message-time text-muted small">
                <i class="fas fa-clock me-1"></i>
                ${timeString}
            </div>
        `;

        messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
    }

    showTypingIndicator() {
        const messagesContainer = document.getElementById('messagesContainer');
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typingIndicator';
        typingDiv.className = 'typing-indicator';
        typingDiv.innerHTML = `
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        `;

        messagesContainer.appendChild(typingDiv);
        this.scrollToBottom();
    }

    hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    async startNewSession() {
        try {
            const response = await fetch('/chatbot/new-session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                }
            });

            const data = await response.json();

            if (data.success) {
                this.currentSessionId = data.session_id;
                
                // Clear messages and show welcome message
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = `
                    <div class="message-bubble bot-message">
                        <div class="message-content">
                            <i class="fas fa-robot me-2 text-primary"></i>
                            ${data.welcome_message}
                        </div>
                        <div class="message-time text-muted small">
                            <i class="fas fa-clock me-1"></i>
                            ${new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error starting new session:', error);
        }
    }

    async loadUserSessions() {
        try {
            const response = await fetch('/chatbot/sessions/');
            const data = await response.json();
            
            if (data.success && data.sessions.length > 0) {
                // You can implement session history sidebar here
                console.log('User sessions loaded:', data.sessions);
            }
        } catch (error) {
            console.error('Error loading sessions:', error);
        }
    }

    scrollToBottom() {
        const chatContainer = document.getElementById('chatContainer');
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    updateSendButton(enabled) {
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = !enabled;
        sendBtn.innerHTML = enabled ? '<i class="fas fa-paper-plane"></i>' : '<i class="fas fa-spinner fa-spin"></i>';
    }

    updateWelcomeTime() {
        const welcomeTime = document.getElementById('welcomeTime');
        if (welcomeTime) {
            welcomeTime.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
               document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
               '';
    }
}

// Initialize chatbot when page loads
document.addEventListener('DOMContentLoaded', () => {
    new ChatbotWidget();
});
</script>
{% endblock %}
